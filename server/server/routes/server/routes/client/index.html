<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnOpenVerseForEveryone | –û–Ω–ª–∞–π–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <style>
        /* –í—Å–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
        /* –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .online-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="online-indicator">üü¢ –û–Ω–ª–∞–π–Ω</div>
    
    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ -->
    <!-- –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—é - —É–±–∏—Ä–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é -->
    <header class="site-header">
        <div class="header-container">
            <div class="site-logo">
                <div class="logo-icon">üìö</div>
                <div class="logo-text">
                    <div class="site-title">AnOpenVerseForEveryone</div>
                    <div class="site-subtitle">–û–Ω–ª–∞–π–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
                </div>
            </div>
            
            <nav class="main-nav">
                <button class="nav-btn active" onclick="Navigation.showHome()">
                    üè† –ì–ª–∞–≤–Ω–∞—è
                </button>
                <button class="nav-btn" onclick="Navigation.showAllPoems()">
                    üìö –í—Å–µ —Å—Ç–∏—Ö–∏
                </button>
                <button class="nav-btn" onclick="Navigation.showAllAuthors()">
                    üë• –ê–≤—Ç–æ—Ä—ã
                </button>
                <button class="nav-btn" onclick="Navigation.showMyPoems()" id="myPoemsBtn" style="display: none;">
                    üìñ –ú–æ–∏ —Å—Ç–∏—Ö–∏
                </button>
                <button class="nav-btn" onclick="Navigation.showAddPoem()" id="addPoemBtn" style="display: none;">
                    ‚úèÔ∏è –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏—Ö
                </button>
                
                <div class="user-menu">
                    <button class="nav-btn" onclick="Navigation.showLogin()" id="loginBtn">
                        üîë –í–æ–π—Ç–∏
                    </button>
                    <div class="user-avatar" id="userAvatar" style="display: none;" onclick="UserMenu.toggle()">
                        U
                        <div class="user-rating" id="userRating">0</div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ) -->
    <div class="main-container">
        <!-- –í—Å–µ —Å–µ–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è -->
    </div>

    <script>
        // –ë–∞–∑–æ–≤—ã–π URL API
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api' 
            : '/api';

        // ==================== –ö–õ–ê–°–° –î–õ–Ø –†–ê–ë–û–¢–´ –° API ====================
        class ApiService {
            static async request(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` }),
                        ...options.headers
                    },
                    ...options
                };

                try {
                    const response = await fetch(`${API_URL}${endpoint}`, config);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            }

            // Auth methods
            static async register(userData) {
                return this.request('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            }

            static async login(credentials) {
                return this.request('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify(credentials)
                });
            }

            static async getCurrentUser() {
                return this.request('/auth/me');
            }

            // Poems methods
            static async getPoems() {
                return this.request('/poems');
            }

            static async getPoem(id) {
                return this.request(`/poems/${id}`);
            }

            static async createPoem(poemData) {
                return this.request('/poems', {
                    method: 'POST',
                    body: JSON.stringify(poemData)
                });
            }

            static async updatePoem(id, poemData) {
                return this.request(`/poems/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(poemData)
                });
            }

            static async deletePoem(id) {
                return this.request(`/poems/${id}`, {
                    method: 'DELETE'
                });
            }

            static async markAsRead(id) {
                return this.request(`/poems/${id}/read`, {
                    method: 'POST'
                });
            }

            static async getUserPoems(userId) {
                return this.request(`/poems/user/${userId}`);
            }

            // Users methods
            static async getUsers() {
                return this.request('/users');
            }

            static async getUser(id) {
                return this.request(`/users/${id}`);
            }

            static async getTopAuthors(limit = 5) {
                return this.request(`/users/top/authors?limit=${limit}`);
            }
        }

        // ==================== –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° –ü–õ–ê–¢–§–û–†–ú–´ (–û–ë–ù–û–í–õ–ï–ù–ù–´–ô) ====================
        class PoetryPlatform {
            static async init() {
                this.users = [];
                this.poems = [];
                this.currentUser = null;
                this.editingPoemId = null;
                
                this.setupEventListeners();
                Modal.setupCloseHandlers();
                
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –ø–æ —Ç–æ–∫–µ–Ω—É
                    const token = localStorage.getItem('token');
                    if (token) {
                        const response = await ApiService.getCurrentUser();
                        this.currentUser = response.user;
                    }
                } catch (error) {
                    localStorage.removeItem('token');
                }
                
                UserMenu.updateUI();
                await Navigation.showHome();
            }

            static async loadAllData() {
                try {
                    const [poemsResponse, usersResponse] = await Promise.all([
                        ApiService.getPoems(),
                        ApiService.getUsers()
                    ]);
                    
                    this.poems = poemsResponse;
                    this.users = usersResponse;
                } catch (error) {
                    Notifications.show('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
            static async handleRegistration() {
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const birthdate = document.getElementById('registerBirthdate').value;
                const bio = document.getElementById('registerBio').value;

                try {
                    const response = await ApiService.register({
                        name, email, password, birthdate, bio
                    });

                    localStorage.setItem('token', response.token);
                    this.currentUser = response.user;
                    UserMenu.updateUI();
                    Notifications.show('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                    Navigation.showHome();
                } catch (error) {
                    Notifications.show(error.message, 'error');
                }
            }

            static async handleLogin() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const response = await ApiService.login({ email, password });
                    
                    localStorage.setItem('token', response.token);
                    this.currentUser = response.user;
                    UserMenu.updateUI();
                    Notifications.show(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${this.currentUser.name}!`);
                    Navigation.showHome();
                } catch (error) {
                    Notifications.show(error.message, 'error');
                }
            }

            static async handleAddPoem() {
                if (!this.currentUser) {
                    Notifications.show('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∏—Ö–æ–≤ –Ω—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç', 'error');
                    return;
                }

                const title = document.getElementById('poemTitle').value;
                const content = document.getElementById('poemContent').value;
                const editPoemId = document.getElementById('editPoemId').value;

                try {
                    if (editPoemId) {
                        await ApiService.updatePoem(editPoemId, { title, content });
                        Notifications.show('–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
                    } else {
                        await ApiService.createPoem({ title, content });
                        Notifications.show('–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!');
                    }

                    this.resetAddPoemForm();
                    await this.loadAllData();
                    Navigation.showMyPoems();
                } catch (error) {
                    Notifications.show(error.message, 'error');
                }
            }

            static async deletePoem(poemId) {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ?')) {
                    return;
                }

                try {
                    await ApiService.deletePoem(poemId);
                    await this.loadAllData();
                    this.renderMyPoems();
                    Notifications.show('–°—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
                } catch (error) {
                    Notifications.show(error.message, 'error');
                }
            }

            static async markAsRead(poemId) {
                try {
                    await ApiService.markAsRead(poemId);
                    await this.loadAllData();
                    Notifications.show('+1 –∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∞!');
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "–£–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
                    if (!error.message.includes('–£–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ')) {
                        Notifications.show(error.message, 'error');
                    }
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            static async renderHomeContent() {
                await this.loadAllData();
                await this.renderTopAuthors();
                this.renderRecentPoems();
                this.renderFeaturedAuthors();
            }

            static async renderTopAuthors() {
                try {
                    const topAuthors = await ApiService.getTopAuthors(3);
                    const container = document.getElementById('topAuthors');
                    
                    if (topAuthors.length === 0) {
                        container.innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: #7f8c8d;">–†–µ–π—Ç–∏–Ω–≥ –∞–≤—Ç–æ—Ä–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç</p>';
                        return;
                    }

                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    container.innerHTML = topAuthors.map((author, index) => {
                        const medal = medals[index] || 'üèÖ';
                        const cardClass = index === 0 ? 'gold' : index === 1 ? 'silver' : 'bronze';
                        
                        return `
                            <div class="top-author-card ${cardClass}">
                                <div class="medal">${medal}</div>
                                <div class="author-avatar-small" style="background: ${author.avatarColor}; width: 60px; height: 60px; margin: 0 auto 10px;">
                                    ${author.name.split(' ').map(n => n[0]).join('')}
                                </div>
                                <h3 style="color: var(--primary-color); margin-bottom: 10px;">${this.escapeHtml(author.name)}</h3>
                                <div class="rating-badge" style="margin: 0 auto;">
                                    üë• ${author.popularity} —á–∏—Ç–∞—Ç–µ–ª–µ–π
                                </div>
                                <div style="margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                                    ${author.poemsCount} —Å—Ç–∏—Ö–æ–≤
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error loading top authors:', error);
                }
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ...

            static async showPoem(poemId) {
                try {
                    const poem = await ApiService.getPoem(poemId);
                    const author = this.users.find(u => u._id === poem.author._id) || poem.author;

                    // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                    await this.markAsRead(poemId);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const initials = author.name.split(' ').map(n => n[0]).join('');

                    document.getElementById('modalTitle').textContent = poem.title;
                    document.getElementById('modalAuthor').innerHTML = `
                        <div class="author-avatar-small" style="background: ${author.avatarColor}">
                            ${initials}
                        </div>
                        ${poem.authorName}
                        ${author.popularity > 0 ? `
                            <span class="rating-badge">
                                üë• ${author.popularity}
                            </span>
                        ` : ''}
                    `;
                    document.getElementById('modalContent').textContent = poem.content;
                    
                    document.getElementById('poemPopularity').innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">
                                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                            </div>
                            <div style="display: flex; justify-content: center; gap: 30px;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: var(--secondary-color);">
                                        ${poem.readers || 0}
                                    </div>
                                    <div style="font-size: 0.9em; color: #7f8c8d;">—á–∏—Ç–∞—Ç–µ–ª–µ–π</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: var(--gold-color);">
                                        ${author.popularity || 0}
                                    </div>
                                    <div style="font-size: 0.9em; color: #7f8c8d;">–ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–∞</div>
                                </div>
                            </div>
                            ${this.currentUser && poem.uniqueReaders.includes(this.currentUser._id) ? 
                                '<div style="margin-top: 10px; color: var(--success-color);">‚úÖ –í—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–∞!</div>' : 
                                '<div style="margin-top: 10px; color: var(--secondary-color);">üëÜ –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Å—Ç–∏—Ö, —á—Ç–æ–±—ã +1 –∫ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∞</div>'
                            }
                        </div>
                    `;
                    
                    document.getElementById('modalDate').textContent = `–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${new Date(poem.createdAt).toLocaleDateString('ru-RU')}`;
                    Modal.open();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    await this.renderHomeContent();
                } catch (error) {
                    Notifications.show(error.message, 'error');
                }
            }

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∫–ª–∞—Å—Å–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏, –Ω–æ —Å async/await
        }

        // –ö–ª–∞—Å—Å—ã Navigation, Modal, UserMenu, Notifications –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        // (—Ç–æ–ª—å–∫–æ —É–±–∏—Ä–∞–µ–º —Ä–∞–∑–¥–µ–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ Navigation)

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            PoetryPlatform.init();
        });
    </script>
</body>
</html>
